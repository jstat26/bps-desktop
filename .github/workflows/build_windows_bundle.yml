name: Build Windows Bundle (dynamic folder + portable R + r_lib + healthcheck + release)

on:
  workflow_dispatch:
    inputs:
      bundle_dir:
        description: "Top-level bundle folder in repo root (e.g., BPS Windows Desktop 1-3.1)"
        required: true
        default: "BPS Windows Desktop 1-2.1"
      r_version:
        description: "R version to use (e.g., 4.4.2)."
        required: true
        default: "4.4.2"
      release_tag:
        description: "Release tag (optional). Leave blank to auto-generate."
        required: false
        default: ""

permissions:
  contents: write

jobs:
  build-windows-bundle:
    runs-on: windows-latest

    env:
      # Provided at dispatch time
      BUNDLE_DIR: ${{ github.event.inputs.bundle_dir }}

      # Relative paths INSIDE the bundle folder
      PREP_REL_PATH: "_BPS_Dashboard_App_Files (do not modify)/prep_r_lib.R"
      APP_REL_PATH: "_BPS_Dashboard_App_Files (do not modify)/app.R"

      # Reliable repo for CI
      R_REPO: "https://packagemanager.posit.co/cran/latest"

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: ${{ github.event.inputs.r_version }}

      - name: Print runner R version
        shell: pwsh
        run: |
          Rscript -e "cat('Runner R version: ', R.version.string, '\n')"

      - name: Derive script paths + versioned zip name
        shell: pwsh
        run: |
          $bundle = "$env:BUNDLE_DIR"
          $prep   = Join-Path $bundle "$env:PREP_REL_PATH"
          $app    = Join-Path $bundle "$env:APP_REL_PATH"
          $appDir = Split-Path -Parent $app

          $safe = $bundle -replace '[^A-Za-z0-9._-]','-'
          $zip  = "BPS_Windows_${safe}_PortableR_with_r_lib.zip"

          "PREP_SCRIPT=$prep" | Out-File -FilePath $env:GITHUB_ENV -Append
          "APP_SCRIPT=$app"   | Out-File -FilePath $env:GITHUB_ENV -Append
          "APP_DIR=$appDir"   | Out-File -FilePath $env:GITHUB_ENV -Append
          "OUT_ZIP=$zip"      | Out-File -FilePath $env:GITHUB_ENV -Append

          Write-Host "BUNDLE_DIR : $bundle"
          Write-Host "PREP_SCRIPT: $prep"
          Write-Host "APP_SCRIPT : $app"
          Write-Host "APP_DIR    : $appDir"
          Write-Host "OUT_ZIP    : $zip"

      - name: Verify bundle paths exist
        shell: pwsh
        run: |
          if (!(Test-Path "$env:BUNDLE_DIR"))  { throw "Bundle directory not found: $env:BUNDLE_DIR" }
          if (!(Test-Path "$env:PREP_SCRIPT")) { throw "prep_r_lib.R not found at: $env:PREP_SCRIPT" }
          if (!(Test-Path "$env:APP_SCRIPT"))  { throw "app.R not found at: $env:APP_SCRIPT" }

      - name: Clean macOS artifact files from bundle (if any)
        shell: pwsh
        run: |
          $bundle = (Resolve-Path "$env:BUNDLE_DIR").Path
          $macosx = Join-Path $bundle "__MACOSX"
          if (Test-Path $macosx) { Remove-Item -Recurse -Force $macosx }

          Get-ChildItem -Path $bundle -Recurse -Force -ErrorAction SilentlyContinue |
            Where-Object { $_.Name -eq ".DS_Store" -or $_.Name -like "._*" } |
            ForEach-Object { Remove-Item -Force $_.FullName -ErrorAction SilentlyContinue }

          Write-Host "Cleanup complete."

      - name: Bundle portable R runtime into the app folder
        shell: pwsh
        run: |
          $rhome = Rscript -e "cat(R.home())"
          if (!(Test-Path $rhome)) { throw "R.home() not found: $rhome" }

          $bundle = (Resolve-Path "$env:BUNDLE_DIR").Path
          $dest   = Join-Path $bundle "R"

          if (Test-Path $dest) { Remove-Item -Recurse -Force $dest }
          New-Item -ItemType Directory -Force -Path $dest | Out-Null

          Copy-Item -Recurse -Force -Path "$rhome\*" -Destination $dest

          $rscript = Join-Path $dest "bin\Rscript.exe"
          $rexe    = Join-Path $dest "bin\R.exe"
          if (!(Test-Path $rscript)) { throw "Bundled Rscript not found at: $rscript" }
          if (!(Test-Path $rexe))    { throw "Bundled R.exe not found at: $rexe" }

          Write-Host "Bundled R runtime into: $dest"
          & $rscript -e "cat('Bundled R version: ', R.version.string, '\n')"
          & $rscript -e "cat('Bundled R.home(): ', R.home(), '\n'); cat('Bundled Rscript: ', Sys.which('Rscript'), '\n')"

      - name: Build shipped r_lib using bundled R
        shell: pwsh
        run: |
          $bundle  = (Resolve-Path "$env:BUNDLE_DIR").Path
          $bundleR = Join-Path $bundle "R\bin\Rscript.exe"
          if (!(Test-Path $bundleR)) { throw "Bundled Rscript missing: $bundleR" }

          $rlib = Join-Path $bundle "r_lib"
          if (Test-Path $rlib) { Remove-Item -Recurse -Force $rlib }
          New-Item -ItemType Directory -Force -Path $rlib | Out-Null

          $env:BPS_BUNDLE_DIR = $bundle
          $env:BPS_R_LIB      = $rlib
          $env:BPS_DASH_LIB   = $rlib
          $env:R_REPO         = "$env:R_REPO"

          & $bundleR --vanilla "$env:PREP_SCRIPT"

          $count = (Get-ChildItem $rlib -Directory | Measure-Object).Count
          if ($count -lt 10) { throw "r_lib looks too small ($count package folders). prep_r_lib.R may be writing to the wrong location." }

          Write-Host "r_lib built at: $rlib"
          Get-ChildItem $rlib -Directory | Select-Object -First 25 | ForEach-Object { $_.Name }

      - name: Ensure app-required packages exist (e.g., tidyverse)
        shell: pwsh
        run: |
          $bundle  = (Resolve-Path "$env:BUNDLE_DIR").Path
          $bundleR = Join-Path $bundle "R\bin\Rscript.exe"
          $rlib    = Join-Path $bundle "r_lib"
          $rlib_fs = ($rlib -replace '\\','/')

          $expr = @"
          options(repos = c(CRAN = Sys.getenv('R_REPO', unset='https://cloud.r-project.org')))
          .libPaths(c('$rlib_fs', .libPaths()))
          needed <- c('tidyverse')
          missing <- needed[!sapply(needed, requireNamespace, quietly=TRUE)]
          if (length(missing)) {
            cat('Installing missing:', paste(missing, collapse=', '), '\n')
            install.packages(missing, dependencies=TRUE)
          }
          cat('Required package check complete.\n')
          "@

          & $bundleR --vanilla -e $expr

      - name: Smoke test (load key packages from shipped r_lib using bundled R)
        shell: pwsh
        run: |
          $bundle  = (Resolve-Path "$env:BUNDLE_DIR").Path
          $bundleR = Join-Path $bundle "R\bin\Rscript.exe"
          $rlib    = Join-Path $bundle "r_lib"

          $pkgs = @(
            "shiny","bs4Dash","DT",
            "tidyverse",
            "dplyr","tidyr","ggplot2","plotly","readr","readxl","lubridate","qs2"
          )

          $pkgs_r   = ($pkgs | ForEach-Object { "'$_'" }) -join ","
          $rlib_fs  = ($rlib -replace '\\','/')

          $expr = @"
          options(repos = c(CRAN = Sys.getenv('R_REPO', unset='https://cloud.r-project.org')))
          .libPaths(c('$rlib_fs', .libPaths()))
          cat('LibPaths:\n'); print(.libPaths())
          pkgs <- c($pkgs_r)
          ok <- sapply(pkgs, function(p) suppressWarnings(require(p, character.only=TRUE)))
          cat('\nLoad results:\n'); print(ok)
          if (any(!ok)) quit(status=2)
          "@

          & $bundleR --vanilla -e $expr

      - name: Install NSIS (reliable)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          choco install nsis -y --no-progress

          $mk = "C:\Program Files (x86)\NSIS\makensis.exe"
          if (!(Test-Path $mk)) {
            # Some installs land here, or choco didn't register Program Files path yet
            $mk = "C:\ProgramData\chocolatey\lib\nsis\tools\makensis.exe"
          }

          if (!(Test-Path $mk)) {
            throw "makensis.exe not found. Looked in Program Files and choco tools."
          }

          & $mk /VERSION
          "MAKENSIS=$mk" | Out-File -FilePath $env:GITHUB_ENV -Append
          Write-Host "Using makensis at: $mk"

      - name: Locate windows_launcher.nsi (auto)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $nsi = Get-ChildItem -Path $env:GITHUB_WORKSPACE -Recurse -Filter "windows_launcher.nsi" -File -ErrorAction SilentlyContinue |
                 Select-Object -First 1

          if (-not $nsi) {
            Write-Host "Could not find windows_launcher.nsi anywhere. Available .nsi files:"
            Get-ChildItem -Path $env:GITHUB_WORKSPACE -Recurse -Filter "*.nsi" -File -ErrorAction SilentlyContinue |
              ForEach-Object { Write-Host $_.FullName }
            throw "windows_launcher.nsi not found anywhere in repo (commit/push it or fix filename)."
          }

          "NSI_PATH=$($nsi.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Append
          Write-Host "Found NSI at: $($nsi.FullName)"

      - name: Build Windows launcher EXE (single icon)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $bundle = "$env:BUNDLE_DIR"

          if (!(Test-Path $env:MAKENSIS)) {
            throw "MAKENSIS not set or not found: $env:MAKENSIS"
          }

          if (!(Test-Path $env:NSI_PATH)) {
            throw "NSI_PATH not set or not found: $env:NSI_PATH"
          }

          & $env:MAKENSIS /DBUNDLE_DIR="$bundle" "$env:NSI_PATH"

          if (!(Test-Path ".\BPS_Dashboard.exe")) {
            throw "Expected NSIS output .\BPS_Dashboard.exe not found. Ensure NSI has: OutFile `"BPS_Dashboard.exe`""
          }

          Move-Item -Force ".\BPS_Dashboard.exe" (Join-Path $bundle "BPS Dashboard.exe")
          Write-Host "Launcher created at: $bundle\BPS Dashboard.exe"

      - name: Create zip (includes the top-level bundle folder)
        if: always()
        shell: pwsh
        run: |
          if (Test-Path "$env:OUT_ZIP") { Remove-Item -Force "$env:OUT_ZIP" }
          Compress-Archive -Path "$env:BUNDLE_DIR" -DestinationPath "$env:OUT_ZIP"
          Write-Host "Created zip: $env:OUT_ZIP"
          Get-Item "$env:OUT_ZIP" | Format-List

      - name: Upload artifact (zip)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: windows-bundle-portableR-with_r_lib
          path: ${{ env.OUT_ZIP }}
          if-no-files-found: error

      - name: Compute release tag/name
        if: success()
        shell: pwsh
        run: |
          $tag = "${{ github.event.inputs.release_tag }}"
          if ([string]::IsNullOrWhiteSpace($tag)) {
            $safe = "$env:BUNDLE_DIR" -replace '[^A-Za-z0-9._-]','-'
            $tag = "windows-$safe-${{ github.run_number }}"
          }
          "RELEASE_TAG=$tag" | Out-File -FilePath $env:GITHUB_ENV -Append
          "RELEASE_NAME=Windows Bundle - $env:BUNDLE_DIR (run ${{ github.run_number }})" | Out-File -FilePath $env:GITHUB_ENV -Append
          Write-Host "Release tag: $tag"

      - name: Create GitHub Release (attach zip)
        if: success()
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: ${{ env.RELEASE_NAME }}
          generate_release_notes: true
          files: ${{ env.OUT_ZIP }}
