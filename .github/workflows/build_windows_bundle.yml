name: Build Windows Bundle (portable R + r_lib)

on:
  workflow_dispatch:
    inputs:
      r_version:
        description: "R version to use (e.g., 4.4.2)."
        required: true
        default: "4.4.2"

jobs:
  build-windows-bundle:
    runs-on: windows-latest

    env:
      # MUST match the folder you ship in your repo (repo root)
      BUNDLE_DIR: "BPS Windows Desktop 1-2.1"

      # Path to prep_r_lib.R inside the bundle folder (relative to repo root)
      PREP_SCRIPT: "BPS Windows Desktop 1-2.1/_BPS_Dashboard_App_Files (do not modify)/prep_r_lib.R"

      # Output zip name (written to repo workspace root)
      OUT_ZIP: "BPS_Windows_Bundle_PortableR_with_r_lib.zip"

      # Reliable repo for CI
      R_REPO: "https://packagemanager.posit.co/cran/latest"

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: ${{ github.event.inputs.r_version }}

      - name: Print runner R version
        shell: pwsh
        run: |
          Rscript -e "cat('Runner R version: ', R.version.string, '\n')"

      - name: Verify bundle paths exist
        shell: pwsh
        run: |
          if (!(Test-Path "${env:BUNDLE_DIR}")) {
            Write-Error "Bundle directory not found: ${env:BUNDLE_DIR}. Update BUNDLE_DIR."
            exit 1
          }
          if (!(Test-Path "${env:PREP_SCRIPT}")) {
            Write-Error "prep_r_lib.R not found at: ${env:PREP_SCRIPT}. Update PREP_SCRIPT."
            exit 1
          }

      - name: Clean macOS artifact files from bundle (if any)
        shell: pwsh
        run: |
          $bundle = (Resolve-Path "${env:BUNDLE_DIR}").Path

          # Remove common macOS junk if it exists
          $macosx = Join-Path $bundle "__MACOSX"
          if (Test-Path $macosx) { Remove-Item -Recurse -Force $macosx }

          Get-ChildItem -Path $bundle -Recurse -Force -ErrorAction SilentlyContinue |
            Where-Object { $_.Name -eq ".DS_Store" -or $_.Name -like "._*" } |
            ForEach-Object { Remove-Item -Force $_.FullName -ErrorAction SilentlyContinue }

          Write-Host "Cleanup complete."

      - name: Bundle portable R runtime into the app folder
        shell: pwsh
        run: |
          $rhome = Rscript -e "cat(R.home())"
          if (!(Test-Path $rhome)) {
            Write-Error "R.home() not found: $rhome"
            exit 1
          }

          $bundle = (Resolve-Path "${env:BUNDLE_DIR}").Path
          $dest   = Join-Path $bundle "R"

          if (Test-Path $dest) { Remove-Item -Recurse -Force $dest }
          New-Item -ItemType Directory -Force -Path $dest | Out-Null

          # Copy the entire R home into .\R\
          Copy-Item -Recurse -Force -Path $rhome\* -Destination $dest

          $rscript = Join-Path $dest "bin\Rscript.exe"
          $rexe    = Join-Path $dest "bin\R.exe"

          if (!(Test-Path $rscript)) { Write-Error "Bundled Rscript not found at: $rscript"; exit 1 }
          if (!(Test-Path $rexe))    { Write-Error "Bundled R.exe not found at: $rexe"; exit 1 }

          Write-Host "Bundled R runtime into: $dest"
          & $rscript -e "cat('Bundled R version: ', R.version.string, '\n')"

      - name: Build shipped r_lib using bundled R
        shell: pwsh
        run: |
          $bundle  = (Resolve-Path "${env:BUNDLE_DIR}").Path
          $bundleR = Join-Path $bundle "R\bin\Rscript.exe"
          if (!(Test-Path $bundleR)) {
            Write-Error "Bundled Rscript missing: $bundleR"
            exit 1
          }

          $rlib = Join-Path $bundle "r_lib"
          if (Test-Path $rlib) { Remove-Item -Recurse -Force $rlib }
          New-Item -ItemType Directory -Force -Path $rlib | Out-Null

          # Env vars used by prep_r_lib.R
          $env:BPS_BUNDLE_DIR = $bundle
          $env:BPS_R_LIB      = $rlib
          $env:BPS_DASH_LIB   = $rlib
          $env:R_REPO         = "${env:R_REPO}"

          & $bundleR --vanilla "${env:PREP_SCRIPT}"

          # Verify r_lib has content
          $count = (Get-ChildItem $rlib -Directory | Measure-Object).Count
          if ($count -lt 10) {
            Write-Error "r_lib looks too small ($count package folders). prep_r_lib.R may be writing to the wrong location."
            exit 1
          }

          Write-Host "r_lib built at: $rlib"
          Get-ChildItem $rlib -Directory | Select-Object -First 25 | ForEach-Object { $_.Name }

      - name: Smoke test (load key packages from shipped r_lib using bundled R)
        shell: pwsh
        run: |
          $bundle  = (Resolve-Path "${env:BUNDLE_DIR}").Path
          $bundleR = Join-Path $bundle "R\bin\Rscript.exe"
          $rlib    = Join-Path $bundle "r_lib"

          $pkgs = @(
            "shiny","bs4Dash","DT","dplyr","tidyr","ggplot2","plotly","readr","readxl","lubridate", "qs2"
          )

          $expr = @"
          options(repos = c(CRAN = Sys.getenv('R_REPO', unset='https://cloud.r-project.org')))
          .libPaths(c(normalizePath('$rlib', winslash='\\\\'), .libPaths()))
          cat('LibPaths:\\n'); print(.libPaths())
          pkgs <- c(${($pkgs | ForEach-Object { "'$_'" }) -join ","})
          ok <- sapply(pkgs, function(p) suppressWarnings(require(p, character.only=TRUE)))
          cat('\\nLoad results:\\n'); print(ok)
          if (any(!ok)) quit(status=2)
          "@

          & $bundleR --vanilla -e $expr

      - name: Create zip (includes the top-level bundle folder)
        shell: pwsh
        run: |
          if (Test-Path "${env:OUT_ZIP}") { Remove-Item -Force "${env:OUT_ZIP}" }

          # Zip the folder itself, so extraction produces "BPS Windows Desktop 1-2.1\..."
          Compress-Archive -Path "${env:BUNDLE_DIR}" -DestinationPath "${env:OUT_ZIP}"
          Write-Host "Created zip: ${env:OUT_ZIP}"
          Get-Item "${env:OUT_ZIP}" | Format-List

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-bundle-portableR-with-r_lib
          path: ${{ env.OUT_ZIP }}
          if-no-files-found: error
